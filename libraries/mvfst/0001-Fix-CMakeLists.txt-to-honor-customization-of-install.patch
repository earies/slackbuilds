From e37fb4e63a11d506256b81a896095064aac576b2 Mon Sep 17 00:00:00 2001
From: Ebben Aries <exa@dscp.org>
Date: Mon, 17 Jul 2023 18:50:21 -0700
Subject: [PATCH] Fix CMakeLists.txt to honor customization of install
 directories

---
 CMakeLists.txt                         | 16 +++++++++++++---
 quic/CMakeLists.txt                    |  4 ++--
 quic/api/CMakeLists.txt                |  4 ++--
 quic/client/CMakeLists.txt             |  2 +-
 quic/codec/CMakeLists.txt              | 12 ++++++------
 quic/common/CMakeLists.txt             | 14 +++++++-------
 quic/congestion_control/CMakeLists.txt |  2 +-
 quic/dsr/CMakeLists.txt                |  4 ++--
 quic/fizz/client/CMakeLists.txt        |  2 +-
 quic/fizz/handshake/CMakeLists.txt     |  2 +-
 quic/flowcontrol/CMakeLists.txt        |  2 +-
 quic/handshake/CMakeLists.txt          |  2 +-
 quic/happyeyeballs/CMakeLists.txt      |  2 +-
 quic/logging/CMakeLists.txt            |  2 +-
 quic/loss/CMakeLists.txt               |  2 +-
 quic/observer/CMakeLists.txt           |  2 +-
 quic/server/CMakeLists.txt             |  6 +++---
 quic/state/CMakeLists.txt              | 18 +++++++++---------
 18 files changed, 54 insertions(+), 44 deletions(-)

diff --git a/CMakeLists.txt b/CMakeLists.txt
index ad054684..0c13e6c3 100644
--- a/CMakeLists.txt
+++ b/CMakeLists.txt
@@ -11,6 +11,13 @@ set(CMAKE_CXX_STANDARD 17)
 set(CMAKE_CXX_STANDARD_REQUIRED ON)
 set(CMAKE_CXX_EXTENSIONS OFF)
 
+set(INCLUDE_INSTALL_DIR include CACHE STRING
+    "The subdirectory where header files should be installed")
+set(LIB_INSTALL_DIR ${CMAKE_INSTALL_LIBDIR} CACHE STRING
+    "The subdirectory where libraries should be installed")
+set(CMAKE_INSTALL_DIR ${CMAKE_INSTALL_LIBDIR}/cmake/mvfst CACHE STRING
+    "The subdirectory where CMake package config files should be installed")
+
 set(CMAKE_MODULE_PATH
   "${CMAKE_CURRENT_SOURCE_DIR}/cmake"
   # for in-fbsource builds
@@ -105,16 +112,19 @@ install(
   EXPORT mvfst-exports
   FILE mvfst-targets.cmake
   NAMESPACE mvfst::
-  DESTINATION lib/cmake/mvfst/
+  DESTINATION ${CMAKE_INSTALL_DIR}
 )
 
 include(CMakePackageConfigHelpers)
 configure_package_config_file(
   cmake/mvfst-config.cmake.in
   ${CMAKE_CURRENT_BINARY_DIR}/mvfst-config.cmake
-  INSTALL_DESTINATION lib/cmake/mvfst/
+  INSTALL_DESTINATION ${CMAKE_INSTALL_DIR}
+  PATH_VARS
+    INCLUDE_INSTALL_DIR
+    CMAKE_INSTALL_DIR
 )
 install(
   FILES ${CMAKE_CURRENT_BINARY_DIR}/mvfst-config.cmake
-  DESTINATION lib/cmake/mvfst/
+  DESTINATION ${CMAKE_INSTALL_DIR}
 )
diff --git a/quic/CMakeLists.txt b/quic/CMakeLists.txt
index d89179fc..3b11ebc3 100644
--- a/quic/CMakeLists.txt
+++ b/quic/CMakeLists.txt
@@ -33,7 +33,7 @@ install(FILES QuicConstants.h DESTINATION include/quic/)
 install(
   TARGETS mvfst_constants
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_library(
@@ -65,7 +65,7 @@ install(FILES QuicException.h DESTINATION include/quic/)
 install(
   TARGETS mvfst_exception
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 add_subdirectory(api)
 add_subdirectory(client)
diff --git a/quic/api/CMakeLists.txt b/quic/api/CMakeLists.txt
index d4f508ed..fe33098b 100644
--- a/quic/api/CMakeLists.txt
+++ b/quic/api/CMakeLists.txt
@@ -139,13 +139,13 @@ endforeach()
 install(
   TARGETS mvfst_transport
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_batch_writer
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/client/CMakeLists.txt b/quic/client/CMakeLists.txt
index c61a0400..29093a0e 100644
--- a/quic/client/CMakeLists.txt
+++ b/quic/client/CMakeLists.txt
@@ -66,7 +66,7 @@ endforeach()
 install(
   TARGETS mvfst_client
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/codec/CMakeLists.txt b/quic/codec/CMakeLists.txt
index 9ca9f125..5b8d24d0 100644
--- a/quic/codec/CMakeLists.txt
+++ b/quic/codec/CMakeLists.txt
@@ -222,37 +222,37 @@ endforeach()
 install(
   TARGETS mvfst_codec_types
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_codec_decode
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_codec_pktbuilder
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_codec_pktrebuilder
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_codec_packet_number_cipher
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_codec
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/common/CMakeLists.txt b/quic/common/CMakeLists.txt
index 02226565..c50ceb23 100644
--- a/quic/common/CMakeLists.txt
+++ b/quic/common/CMakeLists.txt
@@ -173,43 +173,43 @@ endforeach()
 install(
   TARGETS mvfst_looper
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_buf_accessor
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_bufutil
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_events
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_socketutil
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_transport_knobs
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_async_udp_socket_wrapper
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/congestion_control/CMakeLists.txt b/quic/congestion_control/CMakeLists.txt
index 6ad78fc2..13540fd4 100644
--- a/quic/congestion_control/CMakeLists.txt
+++ b/quic/congestion_control/CMakeLists.txt
@@ -66,7 +66,7 @@ endforeach()
 install(
   TARGETS mvfst_cc_algo
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/dsr/CMakeLists.txt b/quic/dsr/CMakeLists.txt
index 7703d9a9..f35654b9 100644
--- a/quic/dsr/CMakeLists.txt
+++ b/quic/dsr/CMakeLists.txt
@@ -121,13 +121,13 @@ install(
 install(
   TARGETS mvfst_dsr_types
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_dsr_frontend
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/fizz/client/CMakeLists.txt b/quic/fizz/client/CMakeLists.txt
index 509fa117..ceb7c8ba 100644
--- a/quic/fizz/client/CMakeLists.txt
+++ b/quic/fizz/client/CMakeLists.txt
@@ -47,7 +47,7 @@ endforeach()
 install(
   TARGETS mvfst_fizz_client
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/fizz/handshake/CMakeLists.txt b/quic/fizz/handshake/CMakeLists.txt
index f88e52e6..abf3a2d2 100644
--- a/quic/fizz/handshake/CMakeLists.txt
+++ b/quic/fizz/handshake/CMakeLists.txt
@@ -53,7 +53,7 @@ endforeach()
 install(
   TARGETS mvfst_fizz_handshake
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/flowcontrol/CMakeLists.txt b/quic/flowcontrol/CMakeLists.txt
index 3da45447..576b910e 100644
--- a/quic/flowcontrol/CMakeLists.txt
+++ b/quic/flowcontrol/CMakeLists.txt
@@ -53,7 +53,7 @@ endforeach()
 install(
   TARGETS mvfst_flowcontrol
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/handshake/CMakeLists.txt b/quic/handshake/CMakeLists.txt
index 9ef75889..46e85e99 100644
--- a/quic/handshake/CMakeLists.txt
+++ b/quic/handshake/CMakeLists.txt
@@ -53,5 +53,5 @@ endforeach()
 install(
   TARGETS mvfst_handshake
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
diff --git a/quic/happyeyeballs/CMakeLists.txt b/quic/happyeyeballs/CMakeLists.txt
index a6c479cb..9ef3e122 100644
--- a/quic/happyeyeballs/CMakeLists.txt
+++ b/quic/happyeyeballs/CMakeLists.txt
@@ -47,5 +47,5 @@ endforeach()
 install(
   TARGETS mvfst_happyeyeballs
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
diff --git a/quic/logging/CMakeLists.txt b/quic/logging/CMakeLists.txt
index 0bfa9fc5..0f9fd95c 100644
--- a/quic/logging/CMakeLists.txt
+++ b/quic/logging/CMakeLists.txt
@@ -50,7 +50,7 @@ endforeach()
 install(
   TARGETS mvfst_qlogger
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/loss/CMakeLists.txt b/quic/loss/CMakeLists.txt
index 8935e749..e56a52c9 100644
--- a/quic/loss/CMakeLists.txt
+++ b/quic/loss/CMakeLists.txt
@@ -57,7 +57,7 @@ endforeach()
 install(
   TARGETS mvfst_loss
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/observer/CMakeLists.txt b/quic/observer/CMakeLists.txt
index 80e2343a..df5e3f12 100644
--- a/quic/observer/CMakeLists.txt
+++ b/quic/observer/CMakeLists.txt
@@ -53,5 +53,5 @@ endforeach()
 install(
   TARGETS mvfst_observer
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
diff --git a/quic/server/CMakeLists.txt b/quic/server/CMakeLists.txt
index 331b7b95..1c04f9c2 100644
--- a/quic/server/CMakeLists.txt
+++ b/quic/server/CMakeLists.txt
@@ -187,19 +187,19 @@ endforeach()
 install(
   TARGETS mvfst_server
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_server_state
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_server_async_tran
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
diff --git a/quic/state/CMakeLists.txt b/quic/state/CMakeLists.txt
index 39ebc9f4..0a69a109 100644
--- a/quic/state/CMakeLists.txt
+++ b/quic/state/CMakeLists.txt
@@ -328,55 +328,55 @@ endforeach()
 install(
   TARGETS mvfst_state_machine
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_state_ack_handler
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_state_datagram_handler
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_state_stream_functions
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_state_pacing_functions
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_state_functions
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_state_simple_frame_functions
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_state_stream
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 install(
   TARGETS mvfst_transport_settings_functions
   EXPORT mvfst-exports
-  DESTINATION lib
+  DESTINATION ${LIB_INSTALL_DIR}
 )
 
 add_subdirectory(test)
-- 
2.41.0

